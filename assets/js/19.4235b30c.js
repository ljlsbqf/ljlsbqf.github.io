(window.webpackJsonp=window.webpackJsonp||[]).push([[19],{338:function(n,s,a){"use strict";a.r(s);var e=a(6),t=Object(e.a)({},(function(){var n=this,s=n._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":n.$parent.slotKey}},[s("h1",{attrs:{id:"semaphore"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#semaphore"}},[n._v("#")]),n._v(" Semaphore:")]),n._v(" "),s("p",[n._v("计数信号量： 从概念上讲，信号量保持一组许可。主要作用限制线程的并发访问的数量，主要通过参数permits的大小控制执行的并发线程的数量")]),n._v(" "),s("h2",{attrs:{id:"_1-方法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-方法"}},[n._v("#")]),n._v(" 1. 方法")]),n._v(" "),s("p",[n._v("有参构造函数主要有2个，\n参数为：int permits 和 boolen fair")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("/**\n * Creates a {@code Semaphore} with the given number of\n * permits and nonfair fairness setting.\n *\n * @param permits the initial number of permits available.\n *        This value may be negative, in which case releases\n *        must occur before any acquires will be granted.\n */\npublic Semaphore(int permits) {\n    sync = new NonfairSync(permits);\n}\n\n/**\n * Creates a {@code Semaphore} with the given number of\n * permits and the given fairness setting.\n *\n * @param permits the initial number of permits available.\n *        This value may be negative, in which case releases\n *        must occur before any acquires will be granted.\n * @param fair {@code true} if this semaphore will guarantee\n *        first-in first-out granting of permits under contention,\n *        else {@code false}\n */\npublic Semaphore(int permits, boolean fair) {\n    sync = fair ? new FairSync(permits) : new NonfairSync(permits);\n}\n\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br"),s("span",{staticClass:"line-number"},[n._v("27")]),s("br")])]),s("h3",{attrs:{id:"主要方法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#主要方法"}},[n._v("#")]),n._v(" 主要方法：")]),n._v(" "),s("p",[n._v("acquire(): 获取(消费)permits\n当线程未获取到permits，当前请求将进入阻塞状态，继续申请获取permits")]),n._v(" "),s("p",[n._v("tryAcquire():尝试获取permits\n如果设置公平参数为true，正常情况当前线程排在队尾，等待资源。但是使用tryAcquire()方法将打破平衡，让当前线程不断尝试获取permits")]),n._v(" "),s("p",[n._v("release():释放(增加)permits\n当调用一次acquire()方法后，相应的需调用一次release()方法释放被消费的permits")]),n._v(" "),s("h2",{attrs:{id:"_2-fair公平参数定义"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-fair公平参数定义"}},[n._v("#")]),n._v(" 2. fair公平参数定义")]),n._v(" "),s("p",[n._v("公平的概念是：获取锁的顺序同线程启动顺序相关，反之即无关。\n当permits>1，多个线程将按照线程的启动顺序从semaphore获取permits并执行。除非调用tryacquire()方法打破这个平衡；\n当permits=1，公平参数就没啥意义了。")]),n._v(" "),s("p",[n._v("semaphore类实现了2个内部类NofairSync和FairSync，继承至内部抽象静态类Sync ，继承至AQS抽象类实现")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v('/**\n * Synchronization implementation for semaphore.  Uses AQS state\n * to represent permits. Subclassed into fair and nonfair\n * versions.\n */\nabstract static class Sync extends AbstractQueuedSynchronizer {\n    private static final long serialVersionUID = 1192457210091910933L;\n\n    Sync(int permits) {\n        setState(permits);\n    }\n\n    final int getPermits() {\n        return getState();\n    }\n    \n    //原子操作判断状态不断获取资源，执行cas操作\n    final int nonfairTryAcquireShared(int acquires) {\n        for (;;) {\n            int available = getState();\n            int remaining = available - acquires;\n            if (remaining < 0 ||\n                compareAndSetState(available, remaining))\n                return remaining;\n        }\n    }\n\n    protected final boolean tryReleaseShared(int releases) {\n        for (;;) {\n            int current = getState();\n            int next = current + releases;\n            if (next < current) // overflow\n                throw new Error("Maximum permit count exceeded");\n            if (compareAndSetState(current, next))\n                return true;\n        }\n    }\n\n    final void reducePermits(int reductions) {\n        for (;;) {\n            int current = getState();\n            int next = current - reductions;\n            if (next > current) // underflow\n                throw new Error("Permit count underflow");\n            if (compareAndSetState(current, next))\n                return;\n        }\n    }\n\n    final int drainPermits() {\n        for (;;) {\n            int current = getState();\n            if (current == 0 || compareAndSetState(current, 0))\n                return current;\n        }\n    }\n}\n\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br"),s("span",{staticClass:"line-number"},[n._v("27")]),s("br"),s("span",{staticClass:"line-number"},[n._v("28")]),s("br"),s("span",{staticClass:"line-number"},[n._v("29")]),s("br"),s("span",{staticClass:"line-number"},[n._v("30")]),s("br"),s("span",{staticClass:"line-number"},[n._v("31")]),s("br"),s("span",{staticClass:"line-number"},[n._v("32")]),s("br"),s("span",{staticClass:"line-number"},[n._v("33")]),s("br"),s("span",{staticClass:"line-number"},[n._v("34")]),s("br"),s("span",{staticClass:"line-number"},[n._v("35")]),s("br"),s("span",{staticClass:"line-number"},[n._v("36")]),s("br"),s("span",{staticClass:"line-number"},[n._v("37")]),s("br"),s("span",{staticClass:"line-number"},[n._v("38")]),s("br"),s("span",{staticClass:"line-number"},[n._v("39")]),s("br"),s("span",{staticClass:"line-number"},[n._v("40")]),s("br"),s("span",{staticClass:"line-number"},[n._v("41")]),s("br"),s("span",{staticClass:"line-number"},[n._v("42")]),s("br"),s("span",{staticClass:"line-number"},[n._v("43")]),s("br"),s("span",{staticClass:"line-number"},[n._v("44")]),s("br"),s("span",{staticClass:"line-number"},[n._v("45")]),s("br"),s("span",{staticClass:"line-number"},[n._v("46")]),s("br"),s("span",{staticClass:"line-number"},[n._v("47")]),s("br"),s("span",{staticClass:"line-number"},[n._v("48")]),s("br"),s("span",{staticClass:"line-number"},[n._v("49")]),s("br"),s("span",{staticClass:"line-number"},[n._v("50")]),s("br"),s("span",{staticClass:"line-number"},[n._v("51")]),s("br"),s("span",{staticClass:"line-number"},[n._v("52")]),s("br"),s("span",{staticClass:"line-number"},[n._v("53")]),s("br"),s("span",{staticClass:"line-number"},[n._v("54")]),s("br"),s("span",{staticClass:"line-number"},[n._v("55")]),s("br"),s("span",{staticClass:"line-number"},[n._v("56")]),s("br"),s("span",{staticClass:"line-number"},[n._v("57")]),s("br"),s("span",{staticClass:"line-number"},[n._v("58")]),s("br")])]),s("h4",{attrs:{id:"fairsync-类"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#fairsync-类"}},[n._v("#")]),n._v(" FairSync 类")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("static final class FairSync extends Sync {\n    private static final long serialVersionUID = 2014338818796000944L;\n\n    FairSync(int permits) {\n        super(permits);\n    }\n    //公平方法处理：是否有线程在处理，有的话，则cas自旋排到队尾\n    protected int tryAcquireShared(int acquires) {\n        for (;;) {\n            if (hasQueuedPredecessors())\n                return -1;\n            int available = getState();\n            int remaining = available - acquires;\n            if (remaining < 0 ||\n                compareAndSetState(available, remaining))\n                return remaining;\n        }\n    }\n}\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br")])]),s("h4",{attrs:{id:"nofairsync"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#nofairsync"}},[n._v("#")]),n._v(" NofairSync:")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("static final class NonfairSync extends Sync {\n    private static final long serialVersionUID = -2694183684443567898L;\n\n    NonfairSync(int permits) {\n        super(permits);\n    }\n    //调用Sync的nonfairTryAcquireShared()获取资源\n    protected int tryAcquireShared(int acquires) {\n        return nonfairTryAcquireShared(acquires);\n    }\n}\n\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br")])]),s("h2",{attrs:{id:"_3-线程安全"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-线程安全"}},[n._v("#")]),n._v(" 3.线程安全：")]),n._v(" "),s("p",[n._v("当permits>1时，semaphore并不能保证线程安全，不能保证获取permits的线程操作安全。因此在操作时，需要加锁或者使用synchronized关键字\n示例代码1：")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("private final static ReentrantLock reentrantLock = new ReentrantLock();\nprivate final static Condition condition = reentrantLock.newCondition();\npublic T acquire(){\n    T t = null;\n    try {\n        semaphore.acquire();\n        reentrantLock.lock();\n        while (list.size()==0){\n            condition.await();\n        }\n        t = list.remove(0);\n    }catch (InterruptedException e){\n        e.printStackTrace();\n    }finally {\n    reentrantLock.unlock();\n}\n    return t;\n}\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br")])]),s("p",[n._v("示例代码2:")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("public synchronized DBConn getData(){\n    DBConn t = null;\n    while (list.size()==0){\n        return acquire();\n    }\n    t = list.remove(0);\n    return t;\n}\npublic DBConn acquire(){\n    DBConn t = null;\n    try {\n        semaphore.acquire();\n        t= getData();\n    }catch (InterruptedException e){\n        e.printStackTrace();\n    }\n    return t;\n}\n\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br")])]),s("p",[n._v("4、总结")]),n._v(" "),s("p",[n._v("1、semaphore的实现依赖AQS，后续仔细了解AQS\n2、semaphore不能保证线程安全，所以在获取permits后，后续对数据的操作需要加锁或者使用synchronized 关键字")])])}),[],!1,null,null,null);s.default=t.exports}}]);